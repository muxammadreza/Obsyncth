name: Testing Release

# This workflow creates beta releases for testing from the dev branch
on:
  push:
    branches:
      - dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build:ci

      - name: Validate build artifacts
        run: |
          if [ ! -f "main.js" ]; then
            echo "‚ùå Build failed: main.js not found"
            exit 1
          fi
          if [ ! -f "manifest.json" ]; then
            echo "‚ùå Build failed: manifest.json not found"
            exit 1
          fi
          if [ ! -f "styles.css" ]; then
            echo "‚ÑπÔ∏è styles.css not found, creating empty file"
            touch styles.css
          fi
          echo "‚úÖ Build artifacts validated successfully"

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BETA_VERSION="${VERSION}-beta.${GITHUB_RUN_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "beta_version=${BETA_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${BETA_VERSION}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "${{ steps.version.outputs.beta_version }} (Beta)"
          body: |
            üß™ **Beta Release for Testing**
            
            This is an automated beta release from the dev branch for testing purposes.
            
            **Installation via BRAT:**
            1. Install the BRAT plugin in Obsidian
            2. Add this repository: `muxammadreza/Obsyncth`
            3. Enable the plugin in your settings
            
            **Version:** ${{ steps.version.outputs.beta_version }}
            **Commit:** ${{ github.sha }}
            
            **üì¶ Files included:**
            - `main.js` - Main plugin code
            - `manifest.json` - Plugin manifest
            - `styles.css` - Plugin styles
            
            ‚ö†Ô∏è This is a beta release. Use with caution in production environments.
          files: |
            main.js
            manifest.json
            styles.css
          prerelease: true
          draft: false
